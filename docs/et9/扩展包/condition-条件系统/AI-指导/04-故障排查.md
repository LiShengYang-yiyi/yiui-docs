# Condition 条件系统 - 故障排查

## 常见问题

### 问题 1: CheckCondition 返回 false

**症状**: 调用 `CheckCondition` 始终返回 false

**排查步骤**:

1. **检查 ConditionMgr 是否已添加**
```csharp
// 确保已添加组件
if (!scene.HasComponent<ConditionMgr>())
{
    scene.AddComponent<ConditionMgr>();
}
```

2. **检查条件配置是否存在**
```csharp
var config = ConditionConfigCategory.Instance.Get(conditionId);
if (config == null)
{
    Log.Error($"条件配置不存在: {conditionId}");
    return false;
}
```

3. **检查监听器是否注册**
```csharp
// 确保添加了条件检查监听
scene.AddCheckConditionGroupListener(OnCheckCondition);

private ETTask<bool> OnCheckCondition(int conditionId)
{
    // 处理条件检查
}
```

---

### 问题 2: 自定义条件不生效

**症状**: 自定义条件类型始终返回 false

**排查步骤**:

1. **检查特性标记**
```csharp
// 确保使用正确的特性
[Condition("YourTypeName")]  // 注意大小写
public class YourCondition : ICondition
{
    public bool Check(long entityId, string param1, string param2, string param3)
    {
        // ...
    }
}
```

2. **检查条件类型匹配**
```csharp
// 配置中的 ConditionType 必须与特性中的名称完全匹配
// 配置: YourTypeName
// 代码: [Condition("YourTypeName")]
```

3. **检查参数解析**
```csharp
public bool Check(long entityId, string param1, string param2, string param3)
{
    // 确保参数格式正确
    if (string.IsNullOrEmpty(param1))
    {
        Log.Warning($"参数1为空");
        return false;
    }

    if (!int.TryParse(param1, out var value))
    {
        Log.Warning($"参数1不是有效的数字: {param1}");
        return false;
    }

    // ...
}
```

---

### 问题 3: 条件变化没有通知

**症状**: 条件改变后 UI 没有更新

**排查步骤**:

1. **检查是否订阅了条件变化**
```csharp
// 订阅条件变化
conditionMgr.Subscribe(conditionId, OnConditionChanged);

private void OnConditionChanged(bool result)
{
    // 更新 UI
}
```

2. **检查是否触发了条件检查**
```csharp
// 条件改变后需要重新检查
await scene.CheckCondition(conditionId);
```

---

### 问题 4: 配置加载失败

**症状**: ConditionConfigCategory 为空

**排查步骤**:

1. **检查 Luban 导出**
```bash
# 确保已导出配置
Luban.Program.Main(new[] { "-c", "config" });
```

2. **检查代码生成**
```csharp
// 确保生成了 ConditionConfigCategory
var count = ConditionConfigCategory.Instance.GetAll().Count;
Log.Debug($"条件配置数量: {count}");
```

---

## 调试技巧

### 启用调试日志

```csharp
// 在条件检查时添加日志
Log.Debug($"[Condition] 检查条件 {conditionId}, 类型: {config.ConditionType}");

var result = await CheckConditionInternal(conditionId);

Log.Debug($"[Condition] 条件 {conditionId} 检查结果: {result}");
```

### 查看所有条件

```csharp
// 打印所有条件配置
foreach (var config in ConditionConfigCategory.Instance.GetAll())
{
    Log.Debug($"Condition: {config.Id}, Type: {config.ConditionType}, Params: {config.Param1},{config.Param2},{config.Param3}");
}
```

### 手动触发条件检查

```csharp
// GM 命令调试
[GM]
public async ETTask DebugCheckCondition(int conditionId)
{
    var result = await Scene.CheckCondition(conditionId);
    Log.Debug($"条件 {conditionId} 检查结果: {result}");
}
```
