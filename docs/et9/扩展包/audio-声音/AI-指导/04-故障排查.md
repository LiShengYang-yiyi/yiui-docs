# Audio 声音 - 故障排查

## 常见问题

### 问题 1: 音频不播放

**症状**: 调用播放方法后没有声音

**排查步骤**:

1. **检查资源是否存在**
```csharp
// 验证资源路径
var clip = await YIUIInvoke.LoadAudioClipAsync("your_audio_path");
if (clip == null)
{
    Log.Error("音频资源加载失败，请检查路径是否正确");
}
```

2. **检查 AudioSource 状态**
```csharp
// 确保 AudioSource 已启用
audioSource.enabled = true;
audioSource.Play();

// 检查是否静音
audioSource.mute = false;
```

3. **检查音量**
```csharp
// 音量不能为 0
audioSource.volume = 1.0f;
```

4. **检查 YooAsset 配置**
- 资源是否添加到组
- 加载方式是否正确
- 资源是否标记为可加载

---

### 问题 2: 初次安装报错

**症状**: 安装包后 Unity 报错或警告

**解决方案**:

1. 点击菜单 `YIUI -> 刷新引用`
2. 如果仍然报错，执行 `Reimport All`

---

### 问题 3: 3D 音效没有空间效果

**症状**: 3D 音频听起来和 2D 一样

**排查步骤**:

1. **检查 SpatialBlend**
```csharp
audioSource.spatialBlend = 1.0f;  // 必须设置为 1 才能有 3D 效果
```

2. **检查距离设置**
```csharp
audioSource.minDistance = 1.0f;   // 开始衰减距离
audioSource.maxDistance = 10.0f;  // 完全衰减距离
```

3. **检查监听器位置**
```csharp
// 确保 Camera 上有 AudioListener
var listener = Camera.main.GetComponent<AudioListener>();
if (listener == null)
{
    Camera.main.gameObject.AddComponent<AudioListener>();
}
```

---

### 问题 4: 配置加载失败

**症状**: `YIUIInvoke.GetAudioConfig` 返回 null

**排查步骤**:

1. **检查 Luban 导出**
- 配置表是否导出
- 导出路径是否正确

2. **检查配置表名称**
```csharp
// 确保使用正确的配置名
var config = YIUIInvoke.GetAudioConfig("正确的配置名");
```

3. **检查代码生成**
- 是否生成了 `AudioConfigCategory`
- 分类是否正确加载

---

### 问题 5: 音效重叠问题

**症状**: 快速点击时音效叠加听起来很乱

**解决方案**:

使用配置中的间隔时间：
```csharp
var config = YIUIInvoke.GetAudioConfig("click");
if (config != null)
{
    // 检查是否可以播放（基于间隔时间）
    if (CanPlay(config))
    {
        PlaySound(clip, volume);
        UpdateLastPlayTime(config);
    }
}
```

或者使用 AudioSource 的 Play() 检查：
```csharp
if (!audioSource.isPlaying)
{
    audioSource.Play();
}
```

---

### 问题 6: 内存占用过高

**症状**: 播放音频时内存快速增长

**解决方案**:

1. **使用异步加载**
```csharp
// 优先使用异步加载
var clip = await YIUIInvoke.LoadAudioClipAsync(path);
```

2. **及时卸载资源**
```csharp
// 不需要时卸载
Resources.UnloadUnusedAssets();
```

3. **使用 Pool 管理**
```csharp
// 复用 AudioSource 而不是频繁创建
```

---

## 调试技巧

### 启用调试日志

在代码中添加日志：
```csharp
Log.Debug($"[Audio] 加载音频: {path}, 结果: {clip != null}");
```

### 查看 AudioSource 状态

```csharp
Debug.Log($"isPlaying: {audioSource.isPlaying}, " +
          $"volume: {audioSource.volume}, " +
          $"spatialBlend: {audioSource.spatialBlend}");
```

### 检查配置加载

```csharp
var config = YIUIInvoke.GetAudioConfig("test");
if (config != null)
{
    Debug.Log($"Volume: {config.GetVolume()}");
    Debug.Log($"Clips: {string.Join(",", config.GetAudioClipNames())}");
}
```
